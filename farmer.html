<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgriAi - Farmer Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ---------- CSS as before ---------- */
    :root {
      --primary: #2e8b57;
      --primary-dark: #246b45;
      --primary-light: #e9f5e9;
      --secondary: #ffa500;
      --accent: #4682b4;
      --text: #333;
      --text-light: #666;
      --bg: #fefefe;
      --card-bg: rgba(255, 255, 255, 0.95);
      --shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    .dark {
      --text: #f0f0f0;
      --text-light: #ccc;
      --bg: #1a1a1a;
      --card-bg: rgba(40, 40, 40, 0.95);
      --primary-light: #1a3020;
      --shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }
    
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
    body { background: linear-gradient(to bottom, var(--primary-light), var(--bg)); color: var(--text); min-height:100vh; transition: var(--transition);}
    
    /* Navbar */
    .navbar { display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem; background: rgba(255,255,255,0.95); backdrop-filter:blur(10px); position:sticky; top:0; z-index:100; box-shadow:0 2px 10px rgba(0,0,0,0.1); transition: var(--transition);}
    .dark .navbar { background: rgba(30,30,30,0.95); box-shadow: 0 2px 10px rgba(0,0,0,0.3);}
    .logo { font-size:1.8rem; font-weight:700; color:var(--primary); display:flex; align-items:center; gap:0.5rem;}
    .nav-links { list-style:none; display:flex; gap:1.5rem;}
    .nav-links a { text-decoration:none; color:var(--text); font-weight:500; padding:0.5rem 0; position:relative; transition: var(--transition);}
    .nav-links a::after { content:''; position:absolute; bottom:0; left:0; width:0; height:2px; background:var(--primary); transition: var(--transition);}
    .nav-links a:hover::after { width:100%;}
    .nav-links a:hover { color:var(--primary);}
    .user-actions { display:flex; align-items:center; gap:1rem;}
    #darkToggle, #languageToggle { background:none; border:none; font-size:1.2rem; cursor:pointer; transition: var(--transition); padding:0.5rem; border-radius:50%; background: var(--primary-light);}
    #darkToggle:hover, #languageToggle:hover { transform: rotate(15deg);}
    
    /* Main container */
    .container { max-width:1400px; margin:2rem auto; padding:0 1.5rem; display:grid; grid-template-columns:1fr 350px; gap:2rem;}
    @media(max-width:1100px) { .container { grid-template-columns:1fr; } }
    
    /* Panels */
    .query-panel, .response-panel, .history-panel { background: var(--card-bg); border-radius:20px; padding:2rem; box-shadow: var(--shadow); transition: var(--transition); margin-bottom:2rem; }
    .query-panel h2, .response-panel h2, .history-panel h2 { margin-bottom:1.5rem; color: var(--primary); display:flex; align-items:center; gap:0.5rem;}
    
    .input-methods { display:flex; gap:0.5rem; margin-bottom:1.5rem; }
    .input-btn { flex:1; padding:0.8rem; border:2px solid var(--primary-light); background:transparent; border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:0.5rem; transition:var(--transition);}
    .input-btn.active { background: var(--primary-light); border-color: var(--primary); color: var(--primary);}
    .input-btn:hover { border-color: var(--primary);}
    
    .text-input { width:100%; min-height:150px; padding:1rem; border:1px solid #ddd; border-radius:10px; resize: vertical; margin-bottom:1rem; transition:var(--transition);}
    .dark .text-input { border-color:#444; background: rgba(50,50,50,0.8); color:var(--text);}
    .text-input:focus { outline:none; border-color: var(--primary); box-shadow:0 0 0 3px rgba(46,139,87,0.2);}
    
    .action-btn { width:100%; padding:1rem; border:none; border-radius:10px; background: var(--primary); color:white; font-size:1.1rem; font-weight:600; cursor:pointer; transition: var(--transition); margin-top:1rem; display:flex; align-items:center; justify-content:center; gap:0.5rem;}
    .action-btn:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow:0 5px 15px rgba(46,139,87,0.3);}
    
    /* Chat container */
    .chat-container { min-height:300px; max-height:500px; overflow-y:auto; padding:1rem; border-radius:10px; background: rgba(0,0,0,0.03); margin-bottom:1.5rem; transition: var(--transition);}
    .dark .chat-container { background: rgba(255,255,255,0.05);}
    .message { margin-bottom:1.5rem; padding:1rem; border-radius:10px; max-width:80%;}
    .message.user { background: var(--primary-light); margin-left:auto; border-bottom-right-radius:0;}
    .message.ai { background: rgba(70,130,180,0.1); margin-right:auto; border-bottom-left-radius:0;}
    .message-header { display:flex; justify-content:space-between; margin-bottom:0.5rem; font-size:0.9rem; color: var(--text-light);}
    
    .confidence-meter { margin:1rem 0;}
    .meter-label { font-size:0.9rem; margin-bottom:0.5rem; color: var(--text-light);}
    .meter-bar { height:10px; background:#eee; border-radius:5px; overflow:hidden;}
    .dark .meter-bar { background:#444;}
    .meter-fill { height:100%; background: var(--primary); border-radius:5px; width:0%; transition: width 1s ease;}
    .meter-value { font-size:0.9rem; text-align:right; margin-top:0.5rem; color: var(--text-light);}
    
    .escalation-notice { background:#fff3cd; color:#856404; padding:1rem; border-radius:8px; margin-top:1rem; border-left:4px solid #ffc107; display:none; align-items:center; gap:0.5rem;}
    
    /* History panel */
    .history-list { max-height:600px; overflow-y:auto;}
    .history-item { padding:1rem; border-left:4px solid var(--primary); margin-bottom:1rem; border-radius:0 8px 8px 0; background: rgba(0,0,0,0.03); transition: var(--transition); cursor:pointer;}
    .dark .history-item { background: rgba(255,255,255,0.05);}
    .history-item:hover { transform: translateX(5px);}
    
    .status-resolved { background:#e8f5e9; color:#2e7d32;}
    .status-pending { background:#fff3cd; color:#856404;}
    .status-escalated { background:#ffebee; color:#c62828;}
    
    /* Notifications */
    .notification { position:fixed; top:20px; right:20px; padding:1rem 1.5rem; border-radius:10px; background: var(--card-bg); box-shadow: var(--shadow); display:flex; align-items:center; gap:0.5rem; z-index:1000; transform:translateX(150%); transition: transform 0.3s ease;}
    .notification.show { transform:translateX(0);}
    .notification.success { border-left:4px solid var(--primary);}
    .notification.error { border-left:4px solid #f44336;}
    
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo"><i class="fas fa-leaf"></i> AgriAi</div>
    <ul class="nav-links">
      <li><a href="#" class="active">Dashboard</a></li>
      <li><a href="#">Analytics</a></li>
      <li><a href="#">Help/FAQ</a></li>
    </ul>
    <div class="user-actions">
      <button id="languageToggle" title="Change language">EN ðŸ‡¬ðŸ‡§</button>
      <button id="darkToggle" title="Toggle dark mode"><i class="fas fa-moon"></i></button>
      <button class="btn-outline"><i class="fas fa-user"></i> Farmer Profile</button>
    </div>
  </nav>

  <div class="container">
    <div class="main-content">
      <!-- Query Panel -->
      <div class="query-panel">
        <h2><i class="fas fa-question-circle"></i> Ask Your Question</h2>
        <div class="input-methods">
          <button class="input-btn active" data-input="text"><i class="fas fa-keyboard"></i> Text</button>
          <button class="input-btn" data-input="voice"><i class="fas fa-microphone"></i> Voice</button>
        </div>
        <!-- Inside your Query Panel, below the textarea -->
         <div class="image-upload-section" style="margin-bottom:1rem;">
           <label for="imageInput" style="display:block; margin-bottom:0.5rem; font-weight:500;">
             Or upload an image of your crop:
            </label>
          <input type="file" id="imageInput" accept="image/png, image/jpeg, image/jpg" style="display:block;">
          </div>

        <div class="input-content text-input-content">
          <textarea class="text-input" placeholder="Type your crop question here..."></textarea>
          <input type="hidden" id="userRegion" value="Maharashtra">
          <input type="hidden" id="userId" value="anonymous">
        </div>
        <div class="input-content voice-input-content" style="display:none;">
          <div class="voice-input"><i class="fas fa-microphone"></i><p>Click microphone and speak</p></div>
        </div>
        <button class="action-btn" id="submitQuery"><i class="fas fa-paper-plane"></i> Submit Question</button>
      </div>

      <!-- Response Panel -->
      <div class="response-panel">
        <h2><i class="fas fa-robot"></i> AI Advice</h2>
        <div class="chat-container">
          <div class="message ai">
            <div class="message-header"><span>AgriAi Assistant</span><span>Just now</span></div>
            <p>Hello! Ask me about crops, pests, irrigation, or anything related to farming.</p>
          </div>
        </div>
        <div class="confidence-meter">
          <div class="meter-label">AI Confidence Level:</div>
          <div class="meter-bar"><div class="meter-fill"></div></div>
          <div class="meter-value">0%</div>
        </div>
        <div class="escalation-notice"><i class="fas fa-exclamation-triangle"></i><div>This query has been escalated to an expert. You will receive a response shortly.</div></div>
      </div>
    </div>

    <!-- History Panel -->
    <div class="history-panel">
      <h2><i class="fas fa-history"></i> Query History</h2>
      <div class="history-list">
        <!-- Loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"><i class="fas fa-info-circle"></i><span id="notificationText">Notification text</span></div>
<script>
 // ---------- JS Code ----------
const darkToggle = document.getElementById('darkToggle');
darkToggle.addEventListener('click', () => document.body.classList.toggle('dark'));

const inputBtns = document.querySelectorAll('.input-btn');
const textInputContent = document.querySelector('.text-input-content');
const voiceInputContent = document.querySelector('.voice-input-content');
inputBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    inputBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if(btn.dataset.input === 'text') {
      textInputContent.style.display = 'block';
      voiceInputContent.style.display = 'none';
    } else {
      textInputContent.style.display = 'none';
      voiceInputContent.style.display = 'block';
    }
  });
});

const submitBtn = document.getElementById('submitQuery');
const chatContainer = document.querySelector('.chat-container');
const meterFill = document.querySelector('.meter-fill');
const meterValue = document.querySelector('.meter-value');
const escalationNotice = document.querySelector('.escalation-notice');
const notification = document.getElementById('notification');
const notificationText = document.getElementById('notificationText');

// Show notifications
function showNotification(msg, type='success') {
  notificationText.textContent = msg;
  notification.className = 'notification show ' + type;
  setTimeout(()=>notification.classList.remove('show'), 3000);
}

// Add message to chat
function addMessage(msg, sender='ai') {
  const div = document.createElement('div');
  div.classList.add('message', sender);
  const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  div.innerHTML = `<div class="message-header"><span>${sender==='ai'?'AgriAi Assistant':'You'}</span><span>${time}</span></div><p>${msg}</p>`;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Update AI confidence meter
function updateConfidence(value=0){
  meterFill.style.width = value*100 + '%';
  meterValue.textContent = Math.round(value*100) + '%';
}

// Fetch and display previous answers (on page load)
async function loadHistory() {
  try {
    const res = await fetch('http://127.0.0.1:5000/api/farmer/answers');
    const data = await res.json();
    data.forEach(a => {
      addMessage(a.response_text, a.responder_type.toLowerCase());
      updateConfidence(a.responder_type==='AI'?0.8:1);
    });
  } catch(err){
    console.log('Error loading history:', err);
  }
}

// Submit text query
async function submitTextQuery(query) {
  escalationNotice.style.display = 'none';
  const region = document.getElementById('userRegion').value;
  const userId = document.getElementById('userId').value;

  const data = { query: query, region: region, user_id: userId };
  try {
    const response = await fetch('http://127.0.0.1:5000/api/query/text', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });

    const result = await response.json();

    if(response.ok){
      if(result.answer && result.confidence >= 0.6){
        // AI answered confidently
        addMessage(result.answer, 'ai');
        updateConfidence(result.confidence);
      } else {
        // Escalated to expert
        escalationNotice.style.display = 'flex';
        addMessage("AI could not confidently answer. Escalating to expert...", 'ai');
      }
      showNotification('Query processed','success');
    } else {
      showNotification(result.error || 'Server error','error');
    }
  } catch(err){
    showNotification(err,'error');
  }
}

// Submit image query
async function submitImageQuery(file) {
  escalationNotice.style.display = 'none';
  const region = document.getElementById('userRegion').value;
  const userId = document.getElementById('userId').value;

  const formData = new FormData();
  formData.append('image', file);
  formData.append('region', region);
  formData.append('user_id', userId);

  try {
    const response = await fetch('http://127.0.0.1:5000/api/query/image', {
      method:'POST',
      body: formData
    });

    const result = await response.json();
    if(response.ok){
      if(result.answer && result.confidence >= 0.6){
        addMessage(result.answer, 'ai');
        updateConfidence(result.confidence);
      } else {
        escalationNotice.style.display = 'flex';
        addMessage("AI could not confidently answer image. Escalating to expert...", 'ai');
      }
      showNotification('Image query processed','success');
    } else {
      showNotification(result.error || 'Server error','error');
    }
  } catch(err){
    showNotification(err,'error');
  }
}

// Button click handler
submitBtn.addEventListener('click', ()=>{
  const query = document.querySelector('.text-input').value.trim();
  const imageInput = document.getElementById('imageInput');
  
  if(query) {
    addMessage(query, 'user');
    submitTextQuery(query);
    document.querySelector('.text-input').value = '';
  } else if(imageInput.files.length > 0){
    const file = imageInput.files[0];
    addMessage('Image uploaded', 'user');
    submitImageQuery(file);
    imageInput.value = '';
  } else {
    showNotification('Please enter a query or upload an image','error');
  }
});

// Load history on page load
window.addEventListener('load', loadHistory);


  </script>
</body>
</html>
